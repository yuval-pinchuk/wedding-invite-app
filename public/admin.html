<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Wedding Invitation Manager</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      padding: 40px;
    }

    h1 {
      color: #333;
      margin-bottom: 10px;
      font-size: 2.5em;
    }

    .subtitle {
      color: #666;
      margin-bottom: 30px;
      font-size: 1.1em;
    }

    .section {
      margin-bottom: 40px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 10px;
    }

    .section h2 {
      color: #333;
      margin-bottom: 20px;
      font-size: 1.5em;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-weight: 600;
    }

    select, button {
      width: 100%;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
      transition: all 0.3s;
    }

    select:focus {
      outline: none;
      border-color: #667eea;
    }

    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 600;
      margin-top: 10px;
    }

    button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .guest-list {
      max-height: 400px;
      overflow-y: auto;
      border: 2px solid #ddd;
      border-radius: 8px;
      padding: 10px;
    }

    .guest-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      margin-bottom: 10px;
      background: white;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
    }

    .guest-info {
      flex: 1;
    }

    .guest-name {
      font-weight: 600;
      color: #333;
      margin-bottom: 5px;
    }

    .guest-phone {
      color: #666;
      font-size: 0.9em;
    }

    .guest-addons {
      color: #888;
      font-size: 0.85em;
      margin-top: 3px;
    }

    .checkbox-container {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .checkbox-container input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
      accent-color: #667eea;
    }

    .guest-item.unselected {
      opacity: 0.6;
      background: #f5f5f5;
    }

    .qr-container {
      text-align: center;
      padding: 20px;
      background: white;
      border-radius: 8px;
      margin-top: 20px;
    }

    .qr-code {
      margin: 20px auto;
      padding: 20px;
      background: white;
      display: inline-block;
      border-radius: 8px;
    }

    .message {
      padding: 15px;
      border-radius: 8px;
      margin-top: 20px;
      display: none;
    }

    .message.show {
      display: block;
    }

    .message.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .message.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .message.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }

    .stats {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
    }

    .stat-box {
      flex: 1;
      padding: 15px;
      background: white;
      border-radius: 8px;
      text-align: center;
    }

    .stat-number {
      font-size: 2em;
      font-weight: bold;
      color: #667eea;
    }

    .stat-label {
      color: #666;
      margin-top: 5px;
    }

    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ðŸ’• Wedding Invitation Manager</h1>
    <p class="subtitle">Manage and send wedding invitations</p>

    <div class="section">
      <h2>1. Select Sender</h2>
      <div class="form-group">
        <label for="senderSelect">Choose a sender:</label>
        <select id="senderSelect">
          <option value="">Loading senders...</option>
        </select>
      </div>
      <button id="loadGuestsBtn" onclick="loadGuests()" disabled>Load Guest List</button>
    </div>

    <div class="section hidden" id="guestsSection">
      <h2>2. Review Guest List</h2>
      <div class="stats">
        <div class="stat-box">
          <div class="stat-number" id="totalGuests">0</div>
          <div class="stat-label">Total Guests</div>
        </div>
        <div class="stat-box">
          <div class="stat-number" id="selectedGuests">0</div>
          <div class="stat-label">Selected to Send</div>
        </div>
      </div>
      <div style="margin-bottom: 15px;">
        <button onclick="selectAll()" style="width: auto; margin-right: 10px; padding: 8px 16px;">Select All</button>
        <button onclick="deselectAll()" style="width: auto; padding: 8px 16px;">Deselect All</button>
      </div>
      <div class="guest-list" id="guestList"></div>
      <button id="confirmBtn" onclick="confirmAndSend()" disabled>Confirm & Send Invitations</button>
    </div>

    <div class="section hidden" id="qrSection">
      <h2>3. Scan QR Code</h2>
      <p>Open WhatsApp on your phone and scan this QR code:</p>
      <div class="qr-container">
        <div id="qrCode" class="qr-code"></div>
        <p id="qrStatus">Initializing WhatsApp...</p>
      </div>
      <div class="message" id="qrMessage"></div>
    </div>

    <div class="section hidden" id="sendingSection">
      <h2>4. Sending Invitations</h2>
      <div id="sendingProgress"></div>
      <div class="message" id="sendingMessage"></div>
    </div>

    <div class="message" id="message"></div>
  </div>

  <script>
    let currentSender = '';
    let guests = [];

    // Load senders on page load
    window.addEventListener('DOMContentLoaded', async () => {
      await loadSenders();
    });

    async function loadSenders() {
      try {
        const response = await fetch('/api/admin/senders');
        const result = await response.json();
        
        if (result.success) {
          const select = document.getElementById('senderSelect');
          select.innerHTML = '<option value="">Select a sender...</option>';
          
          result.senders.forEach(sender => {
            const option = document.createElement('option');
            option.value = sender;
            option.textContent = sender;
            select.appendChild(option);
          });
        } else {
          showMessage('Error loading senders: ' + result.error, 'error');
        }
      } catch (error) {
        showMessage('Error loading senders: ' + error.message, 'error');
      }
    }

    async function loadGuests() {
      const sender = document.getElementById('senderSelect').value;
      if (!sender) {
        showMessage('Please select a sender first', 'error');
        return;
      }

      currentSender = sender;
      showMessage('Loading guests...', 'info');

      try {
        const response = await fetch(`/api/admin/guests/${encodeURIComponent(sender)}`);
        const result = await response.json();
        
        if (result.success) {
          guests = result.guests;
          displayGuests();
          document.getElementById('guestsSection').classList.remove('hidden');
          updateStats();
        } else {
          showMessage('Error loading guests: ' + result.error, 'error');
        }
      } catch (error) {
        showMessage('Error loading guests: ' + error.message, 'error');
      }
    }

    function displayGuests() {
      const list = document.getElementById('guestList');
      list.innerHTML = '';

      if (guests.length === 0) {
        list.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No guests found for this sender.</p>';
        return;
      }

      guests.forEach((guest, index) => {
        const isSelected = guest.sendConfirmation === 'v' || guest.sendConfirmation === 'V';
        const item = document.createElement('div');
        item.className = 'guest-item' + (isSelected ? '' : ' unselected');
        item.innerHTML = `
          <div class="checkbox-container">
            <input type="checkbox" 
                   id="guest-${index}" 
                   ${isSelected ? 'checked' : ''} 
                   onchange="toggleGuest(${index}, this.checked)">
          </div>
          <div class="guest-info" style="flex: 1;">
            <div class="guest-name">${guest.fullName || guest.name}</div>
            <div class="guest-phone">${guest.phoneTo}</div>
            ${guest.addons ? `<div class="guest-addons">+ ${guest.addons}</div>` : ''}
          </div>
        `;
        list.appendChild(item);
      });
    }

    async function toggleGuest(index, isSelected) {
      const guest = guests[index];
      try {
        await updateSendStatus(guest.phoneTo, isSelected);
        // Update the guest object in the array
        guests[index].sendConfirmation = isSelected ? 'v' : '';
        
        // Update the visual state
        const item = document.querySelector(`#guest-${index}`).closest('.guest-item');
        if (isSelected) {
          item.classList.remove('unselected');
        } else {
          item.classList.add('unselected');
        }
        
        updateStats();
      } catch (error) {
        // Revert checkbox on error
        document.getElementById(`guest-${index}`).checked = !isSelected;
        showMessage('Error updating guest status: ' + error.message, 'error');
      }
    }

    async function selectAll() {
      for (let i = 0; i < guests.length; i++) {
        if (guests[i].sendConfirmation !== 'v' && guests[i].sendConfirmation !== 'V') {
          document.getElementById(`guest-${i}`).checked = true;
          await toggleGuest(i, true);
        }
      }
    }

    async function deselectAll() {
      for (let i = 0; i < guests.length; i++) {
        if (guests[i].sendConfirmation === 'v' || guests[i].sendConfirmation === 'V') {
          document.getElementById(`guest-${i}`).checked = false;
          await toggleGuest(i, false);
        }
      }
    }

    async function updateSendStatus(phone, shouldSend) {
      try {
        const response = await fetch('/api/admin/update-send-status', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ phone, shouldSend }),
        });
        const result = await response.json();
        if (!result.success) {
          throw new Error(result.error);
        }
      } catch (error) {
        showMessage('Error updating send status: ' + error.message, 'error');
        throw error;
      }
    }

    function updateStats() {
      const selectedCount = guests.filter(g => g.sendConfirmation === 'v' || g.sendConfirmation === 'V').length;
      document.getElementById('totalGuests').textContent = guests.length;
      document.getElementById('selectedGuests').textContent = selectedCount;
      document.getElementById('confirmBtn').disabled = selectedCount === 0;
    }

    async function confirmAndSend() {
      const selectedGuests = guests.filter(g => g.sendConfirmation === 'v' || g.sendConfirmation === 'V');
      
      if (selectedGuests.length === 0) {
        showMessage('No guests selected to send invitations to', 'error');
        return;
      }

      if (!confirm(`Send invitations to ${selectedGuests.length} guest(s)?`)) {
        return;
      }

      document.getElementById('qrSection').classList.remove('hidden');
      document.getElementById('confirmBtn').disabled = true;

      // Initialize WhatsApp and show QR code
      try {
        const response = await fetch('/api/admin/init-whatsapp', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sender: currentSender }),
        });

        const result = await response.json();
        console.log('[Frontend] init-whatsapp response:', result);
        
        if (result.success) {
          if (result.ready) {
            // Client is already ready (saved session exists)
            console.log('[Frontend] WhatsApp is ready, starting to send invitations...');
            document.getElementById('qrStatus').textContent = 'âœ… WhatsApp is ready!';
            document.getElementById('qrMessage').textContent = result.message || 'WhatsApp is ready using saved session. Starting to send invitations...';
            document.getElementById('qrMessage').classList.add('show', 'success');
            
            // Show sending section
            document.getElementById('sendingSection').classList.remove('hidden');
            
            // Start sending invitations immediately
            setTimeout(() => {
              console.log('[Frontend] Calling sendInvitations()...');
              sendInvitations();
            }, 1000);
          } else if (result.qrCode) {
            // Display QR code
            console.log('[Frontend] QR code received, displaying...');
            displayQRCode(result.qrCode);
            document.getElementById('qrStatus').textContent = 'Scan the QR code with WhatsApp to continue...';
            
            // Poll for ready status
            pollWhatsAppStatus();
          } else {
            // No QR and not ready - wait a bit and poll
            console.log('[Frontend] No QR code yet, starting to poll...');
            document.getElementById('qrStatus').textContent = 'Initializing WhatsApp...';
            pollWhatsAppStatus();
          }
        } else {
          throw new Error(result.error || 'Failed to initialize WhatsApp');
        }
      } catch (error) {
        showMessage('Error initializing WhatsApp: ' + error.message, 'error');
      }
    }

    function displayQRCode(qrCode) {
      console.log('[Frontend] displayQRCode called with QR code length:', qrCode ? qrCode.length : 'null');
      
      const qrContainer = document.getElementById('qrCode');
      if (!qrContainer) {
        console.error('[Frontend] QR container not found!');
        return;
      }
      
      qrContainer.innerHTML = '';
      
      if (!qrCode) {
        console.error('[Frontend] No QR code provided to displayQRCode');
        qrContainer.innerHTML = '<p style="color: red;">Error: No QR code available</p>';
        return;
      }
      
      // Function to actually render the QR code
      function renderQR() {
        // Check for QRCode library - try multiple possible names
        let QRCodeLib = window.QRCode || window.qrcode || (typeof QRCode !== 'undefined' ? QRCode : null);
        
        if (!QRCodeLib) {
          console.error('[Frontend] QRCode library not available');
          console.log('[Frontend] Checking window properties:', Object.keys(window).filter(k => k.toLowerCase().includes('qr')));
          qrContainer.innerHTML = '<p style="color: orange;">Waiting for QR code library to load...</p>';
          // Retry after a short delay (max 5 seconds)
          if (!renderQR.retryCount) renderQR.retryCount = 0;
          renderQR.retryCount++;
          if (renderQR.retryCount < 10) {
            setTimeout(renderQR, 500);
          } else {
            qrContainer.innerHTML = '<p style="color: red;">QR code library failed to load. Please refresh the page.</p>';
          }
          return;
        }
        
        try {
          console.log('[Frontend] Generating QR code using QRCodeLib.toDataURL...');
          console.log('[Frontend] QRCodeLib type:', typeof QRCodeLib);
          console.log('[Frontend] QRCodeLib methods:', Object.keys(QRCodeLib || {}));
          
          // Use toDataURL to create an image URL, which is more reliable
          QRCodeLib.toDataURL(qrCode, {
            width: 256,
            margin: 2,
            color: {
              dark: '#000000',
              light: '#FFFFFF'
            }
          }, function (error, url) {
            if (error) {
              console.error('[Frontend] Error generating QR code:', error);
              // Fallback: try toCanvas method
              try {
                const canvas = document.createElement('canvas');
                QRCodeLib.toCanvas(canvas, qrCode, {
                  width: 256,
                  margin: 2,
                  color: {
                    dark: '#000000',
                    light: '#FFFFFF'
                  }
                }, function (canvasError) {
                  if (canvasError) {
                    console.error('[Frontend] Canvas method also failed:', canvasError);
                    qrContainer.innerHTML = `<p style="color: red;">Error generating QR code. Please try refreshing the page.</p><pre style="font-size: 10px; word-break: break-all;">${qrCode.substring(0, 100)}...</pre>`;
                  } else {
                    console.log('[Frontend] QR code canvas generated successfully');
                    qrContainer.appendChild(canvas);
                  }
                });
              } catch (e) {
                console.error('[Frontend] Exception:', e);
                qrContainer.innerHTML = `<p style="color: red;">Error: ${e.message}</p>`;
              }
            } else {
              console.log('[Frontend] QR code image generated successfully');
              const img = document.createElement('img');
              img.src = url;
              img.alt = 'WhatsApp QR Code';
              img.style.display = 'block';
              img.style.margin = '0 auto';
              qrContainer.appendChild(img);
            }
          });
          
          const instruction = document.createElement('p');
          instruction.style.marginTop = '10px';
          instruction.textContent = 'Scan this QR code with WhatsApp (Settings > Linked Devices > Link a Device)';
          qrContainer.appendChild(instruction);
        } catch (error) {
          console.error('[Frontend] Exception in displayQRCode:', error);
          qrContainer.innerHTML = `<p style="color: red;">Error displaying QR code: ${error.message}</p>`;
        }
      }
      
      // Start rendering
      renderQR();
    }

    async function pollWhatsAppStatus() {
      let qrCodeDisplayed = false;
      const interval = setInterval(async () => {
        try {
          const response = await fetch(`/api/admin/whatsapp-status/${encodeURIComponent(currentSender)}`);
          const result = await response.json();
          console.log('[Frontend] Status poll result:', result);
          
          // Check for QR code first (if not already displayed)
          if (!qrCodeDisplayed && result.qr) {
            console.log('[Frontend] QR code found in status, displaying...');
            displayQRCode(result.qr);
            document.getElementById('qrStatus').textContent = 'Scan the QR code with WhatsApp to continue...';
            qrCodeDisplayed = true;
          }
          
          if (result.ready) {
            clearInterval(interval);
            document.getElementById('qrStatus').textContent = 'âœ… WhatsApp connected!';
            document.getElementById('qrMessage').textContent = 'WhatsApp is ready. Starting to send invitations...';
            document.getElementById('qrMessage').classList.add('show', 'success');
            
            // Start sending invitations
            setTimeout(() => {
              sendInvitations();
            }, 2000);
          }
        } catch (error) {
          console.error('Error checking WhatsApp status:', error);
        }
      }, 3000);
    }

    async function sendInvitations() {
      const selectedGuests = guests.filter(g => g.sendConfirmation === 'v' || g.sendConfirmation === 'V');
      
      console.log('[Frontend] sendInvitations called with', selectedGuests.length, 'guests');
      console.log('[Frontend] Selected guests:', selectedGuests);
      
      document.getElementById('sendingSection').classList.remove('hidden');
      const progressDiv = document.getElementById('sendingProgress');
      const messageDiv = document.getElementById('sendingMessage');
      
      messageDiv.textContent = `Sending invitations to ${selectedGuests.length} guest(s)...`;
      messageDiv.classList.add('show', 'info');

      try {
        const requestBody = {
          sender: currentSender,
          guests: selectedGuests.map(g => ({
            name: g.name,
            phone: g.phoneTo,
            addons: g.addons,
          })),
        };
        
        console.log('[Frontend] Sending request to /api/admin/send-invitations');
        console.log('[Frontend] Request body:', requestBody);
        
        const response = await fetch('/api/admin/send-invitations', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(requestBody),
        });

        console.log('[Frontend] Response status:', response.status);
        const result = await response.json();
        console.log('[Frontend] Response result:', result);
        
        if (result.success) {
          messageDiv.textContent = `âœ… Successfully sent ${result.successful} invitation(s)!`;
          messageDiv.classList.remove('info');
          messageDiv.classList.add('success');
          
          if (result.failed > 0) {
            messageDiv.textContent += ` ${result.failed} failed.`;
          }
        } else {
          throw new Error(result.error || 'Failed to send invitations');
        }
      } catch (error) {
        messageDiv.textContent = 'Error: ' + error.message;
        messageDiv.classList.remove('info');
        messageDiv.classList.add('error');
      }
    }

    function showMessage(text, type = 'info') {
      const messageDiv = document.getElementById('message');
      messageDiv.textContent = text;
      messageDiv.className = `message show ${type}`;
      setTimeout(() => {
        messageDiv.classList.remove('show');
      }, 5000);
    }

    // Enable load button when sender is selected and hide previous sections
    document.getElementById('senderSelect').addEventListener('change', function() {
      document.getElementById('loadGuestsBtn').disabled = !this.value;
      
      // Hide all sections when sender changes (guests, QR code, and sending)
      document.getElementById('guestsSection').classList.add('hidden');
      document.getElementById('qrSection').classList.add('hidden');
      document.getElementById('sendingSection').classList.add('hidden');
      
      // Clear QR code display
      const qrContainer = document.getElementById('qrCode');
      if (qrContainer) {
        qrContainer.innerHTML = '';
      }
      
      // Reset status messages
      document.getElementById('qrStatus').textContent = 'Initializing WhatsApp...';
      const qrMessage = document.getElementById('qrMessage');
      if (qrMessage) {
        qrMessage.classList.remove('show', 'success', 'error', 'info');
        qrMessage.textContent = '';
      }
      
      // Reset current sender and guests
      if (this.value) {
        currentSender = this.value;
      } else {
        currentSender = '';
      }
      guests = []; // Clear the guests array
    });
  </script>
  <!-- Load QRCode library - using qrcodejs which works reliably with script tags -->
  <script src="https://cdn.jsdelivr.net/gh/davidshimjs/qrcodejs@gh-pages/qrcode.min.js"></script>
  <script>
    // Create adapter to match the API we're using (toDataURL and toCanvas)
    (function() {
      window.addEventListener('load', function() {
        setTimeout(function() {
          if (typeof QRCode !== 'undefined') {
            console.log('[Frontend] QRCode library loaded');
            // Store original QRCode constructor
            const OriginalQRCode = window.QRCode;
            
            // Create adapter with toDataURL and toCanvas methods
            window.QRCode = {
              toDataURL: function(text, options, callback) {
                const div = document.createElement('div');
                div.style.display = 'none';
                document.body.appendChild(div);
                try {
                  const qr = new OriginalQRCode(div, {
                    text: text,
                    width: options.width || 256,
                    height: options.width || 256,
                    colorDark: (options.color && options.color.dark) || '#000000',
                    colorLight: (options.color && options.color.light) || '#FFFFFF',
                    correctLevel: OriginalQRCode.CorrectLevel.M
                  });
                  setTimeout(function() {
                    const canvas = div.querySelector('canvas');
                    if (canvas) {
                      callback(null, canvas.toDataURL());
                    } else {
                      callback(new Error('Failed to generate QR code canvas'));
                    }
                    document.body.removeChild(div);
                  }, 50);
                } catch (e) {
                  document.body.removeChild(div);
                  callback(e);
                }
              },
              toCanvas: function(canvas, text, options, callback) {
                const div = document.createElement('div');
                div.style.display = 'none';
                document.body.appendChild(div);
                try {
                  const qr = new OriginalQRCode(div, {
                    text: text,
                    width: options.width || 256,
                    height: options.width || 256,
                    colorDark: (options.color && options.color.dark) || '#000000',
                    colorLight: (options.color && options.color.light) || '#FFFFFF',
                    correctLevel: OriginalQRCode.CorrectLevel.M
                  });
                  setTimeout(function() {
                    const srcCanvas = div.querySelector('canvas');
                    if (srcCanvas && canvas) {
                      const ctx = canvas.getContext('2d');
                      canvas.width = options.width || 256;
                      canvas.height = options.width || 256;
                      ctx.drawImage(srcCanvas, 0, 0);
                      callback(null);
                    } else {
                      callback(new Error('Failed to generate QR code canvas'));
                    }
                    document.body.removeChild(div);
                  }, 50);
                } catch (e) {
                  document.body.removeChild(div);
                  callback(e);
                }
              }
            };
            console.log('[Frontend] QRCode adapter created successfully');
          } else {
            console.error('[Frontend] QRCode library failed to load');
          }
        }, 100);
      });
    })();
  </script>
</body>
</html>

